<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>History Class Points ‚Äî Teacher Dashboard (Login)</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f0f4f8; --card:#fff; --primary:#003366; --accent:#0055aa; --text:#222;
    --positive: #007a00; --negative: #b20000; --zero: #555;
  }
  .theme-dark{ --bg:#0f1720; --card:#11151a; --primary:#0ea5a0; --accent:#14b8a6; --text:#eef2ff; }
  .theme-chalk{ --bg:#223322; --card:#2b4b2b; --primary:#a3d977; --accent:#f5f48a; --text:#f6f6f2; }
  .theme-retro{ --bg:#0b1226; --card:#07102a; --primary:#7ec8ff; --accent:#ffd34d; --text:#dff4ff; font-family: "Courier New", monospace; }

  html,body { height:100%; margin:0; padding:0; }
  body {
    background:var(--bg); color:var(--text); font-family: "Segoe UI", Roboto, system-ui, Arial; display:flex; flex-direction:column; align-items:center; padding-bottom:40px;
  }

  header{ width:100%; background:var(--primary); color:white; padding:18px 10px; box-shadow:0 3px 6px rgba(0,0,0,0.12); text-align:center; font-size:1.15rem; font-weight:600; }
  .container { width:92%; max-width:1000px; margin-top:18px; }

  /* Tabs */
  .tabs { display:flex; gap:8px; justify-content:center; margin-bottom:6px; }
  .tab-btn { background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; transition:background .15s; }
  .tab-btn:hover{ background:var(--accent); }
  .tab-btn.active{ background:var(--accent); font-weight:700; }

  .panel { display:none; margin-top:6px; background:var(--card); padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  .panel.active{ display:block; }

  /* STUDENT LIST GRID */
  .student-list { margin-top:12px; }
  .student-row {
    display:grid;
    grid-template-columns: 2fr 120px 200px; /* name | points | controls */
    gap:10px; align-items:center; padding:10px 8px; border-bottom:1px solid rgba(0,0,0,0.06);
  }
  .student-row .name { text-align:left; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .student-row .points { text-align:center; font-weight:700; }
  .student-row .controls { display:flex; justify-content:flex-end; gap:6px; }

  input[type="text"], input[type="number"], select {
    padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.12); width:100%;
  }

  button.small { padding:6px 10px; border-radius:8px; border:none; cursor:pointer; background:var(--primary); color:white; }
  button.danger { background:var(--negative); color:white; }
  button.ghost { background:transparent; border:1px solid rgba(0,0,0,0.08); color:var(--text); }

  /* Podium */
  .podium { display:flex; gap:16px; justify-content:center; flex-wrap:wrap; margin-top:8px; }
  .podium .box { width:140px; padding:12px; border-radius:10px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.08); font-weight:700; }
  .podium .gold { background:gold; color:#222; }
  .podium .silver { background:silver; color:#222; }
  .podium .bronze { background:#cd7f32; color:white; }

  /* Full leaderboard table (collapsible) */
  .leaderboard-table { width:100%; border-collapse:collapse; margin-top:14px; font-size:0.95rem; }
  .leaderboard-table th, .leaderboard-table td { padding:10px 8px; border-bottom:1px solid rgba(0,0,0,0.06); text-align:left; }
  .leaderboard-table th { background:var(--primary); color:white; font-weight:700; position:sticky; top:0; z-index:1; }
  .row-even { background: rgba(0,0,0,0.02); }

  .points-pos { color:var(--positive); font-weight:700; }
  .points-zero { color:var(--zero); font-weight:700; }
  .points-neg { color:var(--negative); font-weight:700; }

  /* Admin grid */
  .admin-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:start; }
  .tool { background:rgba(255,255,255,0.02); padding:12px; border-radius:8px; }

  .search-row{ display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .small { width:120px; }

  .chart-wrap { margin-top:12px; background:var(--card); padding:12px; border-radius:8px; }

  /* Login overlay */
  .login-screen { position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .login-card { width:360px; background:var(--card); padding:18px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.3); }
  .login-card h2 { margin:0 0 10px 0; }

  /* responsive tweaks */
  @media (max-width:820px){
    .student-row { grid-template-columns: 1fr 80px 140px; }
    .podium .box { width:110px; }
    .admin-grid { grid-template-columns:1fr; }
    .login-card{ width:92%; }
  }
</style>
</head>
<body>
<header>üèõÔ∏è History Class Points ‚Äî Teacher Dashboard</header>

<div class="container" id="mainUI" style="display:none;">
  <div style="display:flex; gap:8px; align-items:center; margin:12px 0;">
    <div style="flex:1;">
      <div class="tabs" id="tabs">
        <button class="tab-btn active" data-tab="students">üë©‚Äçüéì Students</button>
        <button class="tab-btn" data-tab="leaderboard">üèÜ Leaderboard</button>
        <button class="tab-btn" data-tab="admin">‚öôÔ∏è Admin</button>
        <button class="tab-btn" data-tab="graphs">üìä Graphs</button>
        <button class="tab-btn" data-tab="themes">üé® Themes</button>
      </div>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <div id="currentUser" style="font-weight:600;"></div>
      <button class="small" id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- STUDENTS -->
  <section id="students" class="panel active">
    <div style="display:flex; gap:10px; align-items:center;">
      <input id="addName" type="text" placeholder="New student name" />
      <button class="small" id="addBtn">Add</button>

      <select id="quickAdd" class="small">
        <option value="0">Quick +</option>
        <option value="1">+1</option>
        <option value="5">+5</option>
        <option value="10">+10</option>
      </select>
      <button class="small" id="applyQuick">Apply to selected</button>
    </div>

    <div style="margin-top:12px;">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="selectSearch" type="text" placeholder="Search by name..." />
        <button class="small" id="searchClear">Clear</button>
        <label style="margin-left:auto;">Sort students:</label>
        <select id="studentSort" style="width:160px;">
          <option value="alpha">Alphabetical (A‚ÜíZ)</option>
          <option value="points_desc">Points (high‚Üílow)</option>
        </select>
      </div>
      <div class="student-list" id="studentList"></div>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="leaderboard" class="panel">
    <h3>Top 3 Podium</h3>
    <div id="podium" class="podium"></div>

    <div style="text-align:center; margin-top:12px;">
      <button id="toggleFullBtn" class="small">Show Full Leaderboard ‚Üì</button>
    </div>

    <div id="fullBoard" style="margin-top:12px; display:none;">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <label>View snapshot:</label>
        <select id="snapshotSelect" style="min-width:220px;"></select>
        <button class="small" id="refreshSnapshot">Refresh</button>
      </div>

      <table class="leaderboard-table" id="leaderboardTable">
        <thead>
          <tr><th style="width:60px">Rank</th><th>Student Name</th><th style="width:120px">Points</th></tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin" class="panel">
    <h3>Admin Tools</h3>
    <div class="admin-grid">
      <div class="tool">
        <h4>Roster</h4>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="importInput" type="text" placeholder="Paste comma-separated names" />
          <button class="small" id="importBtn">Import</button>
        </div>

        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <button class="small" id="saveDataBtn">üíæ Save Data (download JSON)</button>
          <input id="loadFile" type="file" accept=".json" style="display:none" />
          <button class="small" id="loadDataBtn">üìÇ Load Data (upload JSON)</button>
          <button class="small danger" id="wipeAll">Wipe All Data</button>
        </div>

        <h4>Adjust Student</h4>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="chooseName" type="text" placeholder="Exact student name" />
          <input id="setPoints" type="number" placeholder="Set points" />
          <button class="small" id="applySet">Set</button>
        </div>

        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="renameOld" type="text" placeholder="Old exact name" />
          <input id="renameNew" type="text" placeholder="New name" />
          <button class="small" id="renameBtn">Rename</button>
        </div>
      </div>

      <div class="tool">
        <h4>Quick Operations</h4>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <select id="quickAmount"><option value="5">+5</option><option value="10">+10</option><option value="-5">-5</option></select>
          <input id="quickTarget" type="text" placeholder="Student name" />
          <button class="small" id="quickApply">Apply</button>
        </div>

        <h4>Weekly Resets & History</h4>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <button class="small" id="resetWeek">Reset Week (archive)</button>
          <button class="small" id="clearHistory">Clear History</button>
        </div>

        <h4>Display</h4>
        <div style="display:flex; gap:8px; align-items:center;">
          <label>Leaderboard sort:</label>
          <select id="leaderSort"><option value="points">Points (desc)</option><option value="alpha">Alphabetical</option></select>
        </div>
      </div>
    </div>
  </section>

  <!-- GRAPHS -->
  <section id="graphs" class="panel">
    <h3>Graphs</h3>
    <div style="display:flex; gap:8px; align-items:center;">
      <label>Choose snapshot:</label>
      <select id="graphSnapshot" style="min-width:220px"></select>
      <button class="small" id="drawGraph">Draw</button>
    </div>
    <div class="chart-wrap">
      <canvas id="pointsChart" height="140"></canvas>
    </div>
  </section>

  <!-- THEMES -->
  <section id="themes" class="panel">
    <h3>Themes</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="small" data-theme="default">Light (Default)</button>
      <button class="small" data-theme="dark">Dark</button>
      <button class="small" data-theme="chalk">Chalkboard</button>
      <button class="small" data-theme="retro">Retro</button>
    </div>
  </section>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <h2>Teacher Login</h2>
    <div style="margin-bottom:10px;">
      <input id="loginUser" type="text" placeholder="Username" style="width:100%; margin-bottom:8px;" />
      <input id="loginPass" type="password" placeholder="Password" style="width:100%;" />
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button class="small" id="btnRegister">Register</button>
      <button class="small" id="btnLogin">Log In</button>
    </div>
    <hr style="margin:10px 0;">
    <div style="font-size:0.9em; color:gray;">
      Tip: Register with a username you remember. Your data is stored in this browser. Use "Save Data" in Admin to export a backup.
    </div>
  </div>
</div>

<script>
/* ==========================
   Storage & Account helpers
   ========================== */
const ACCOUNTS_KEY = 'hc_accounts_v1';

async function hashPassword(password){
  // SHA-256 hex digest
  const enc = new TextEncoder();
  const data = enc.encode(password);
  const hash = await crypto.subtle.digest('SHA-256', data);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b => b.toString(16).padStart(2,'0')).join('');
}

function loadAccounts(){
  try {
    const raw = localStorage.getItem(ACCOUNTS_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch(e){ console.error(e); return {}; }
}
function saveAccounts(accounts){
  localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accounts));
}

/* Default structure for teacher data */
function defaultTeacherData(){
  return {
    students: [],
    history: [],
    settings: { theme: 'default', leaderSort: 'points' }
  };
}

/* App state for current logged-in teacher */
let currentUser = null;
let currentPassHash = null;
let teacherData = defaultTeacherData();

/* ==========================
   Login & Account UI logic
   ========================== */

const loginScreen = document.getElementById('loginScreen');
const mainUI = document.getElementById('mainUI');
const currentUserLabel = document.getElementById('currentUser');

document.getElementById('btnRegister').addEventListener('click', async ()=>{
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!user || !pass) return alert('Enter username and password');
  const accounts = loadAccounts();
  if(accounts[user]) return alert('Username already exists');
  const passHash = await hashPassword(pass);
  accounts[user] = { passwordHash: passHash, data: defaultTeacherData() };
  saveAccounts(accounts);
  alert('Registered. Now log in with your credentials.');
});

document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!user || !pass) return alert('Enter username and password');
  const accounts = loadAccounts();
  const acct = accounts[user];
  if(!acct) return alert('No such user. Register first.');
  const passHash = await hashPassword(pass);
  if(passHash !== acct.passwordHash) return alert('Incorrect password');
  // success
  currentUser = user;
  currentPassHash = passHash;
  teacherData = acct.data || defaultTeacherData();
  // show main UI
  loginScreen.style.display = 'none';
  mainUI.style.display = 'block';
  currentUserLabel.textContent = `Teacher: ${currentUser}`;
  applyTheme();
  renderAll();
});

/* Logout */
document.getElementById('logoutBtn').addEventListener('click', ()=> {
  if(!confirm('Log out?')) return;
  // persist teacherData to account
  persistTeacherToAccounts();
  currentUser = null; currentPassHash = null; teacherData = defaultTeacherData();
  mainUI.style.display = 'none';
  loginScreen.style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
});

/* Persist teacher data into accounts store */
function persistTeacherToAccounts(){
  if(!currentUser) return;
  const accounts = loadAccounts();
  if(!accounts[currentUser]) accounts[currentUser] = { passwordHash: currentPassHash, data: teacherData };
  else accounts[currentUser].data = teacherData;
  saveAccounts(accounts);
}

/* ==========================
   Helper functions for teacherData
   ========================== */
function cloneStudents(arr){ return arr.map(s => ({ name: s.name, points: s.points })); }
function findStudentByName(name){ return teacherData.students.find(s => s.name === name); }
function normalizeName(n){ return n.trim(); }

/* Sorting */
function sortForLeaderboard(arr, mode = teacherData.settings.leaderSort){
  const copy = [...arr];
  if(mode === 'alpha') copy.sort((a,b)=> a.name.localeCompare(b.name));
  else copy.sort((a,b)=> {
    if(b.points === a.points) return a.name.localeCompare(b.name);
    return b.points - a.points;
  });
  return copy;
}

/* ==========================
   UI wiring (main app)
   ========================== */

/* Tab buttons */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=> b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=> p.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.dataset.tab;
    document.getElementById(id).classList.add('active');
    if(id === 'leaderboard') syncSnapshotSelect();
    if(id === 'graphs') syncGraphSelect();
  });
});

/* load & save to local accounts when important actions happen */
function saveTeacherDataAndPersist(){
  persistTeacherToAccounts();
  // also save a top-level marker (optional) - not needed
}

/* Render all */
function renderAll(){
  applyTheme();
  renderStudents();
  renderLeaderboard();
  syncSnapshotSelect();
  syncGraphSelect();
  document.getElementById('leaderSort').value = teacherData.settings.leaderSort || 'points';
  saveTeacherDataAndPersist();
}

/* STUDENTS tab actions */
document.getElementById('addBtn').addEventListener('click', ()=>{
  const name = normalizeName(document.getElementById('addName').value);
  if(!name) return alert('Enter a student name');
  if(teacherData.students.some(s => s.name.toLowerCase() === name.toLowerCase())) return alert('Student exists');
  teacherData.students.push({ name, points: 0 });
  document.getElementById('addName').value = '';
  renderAll();
});

document.getElementById('applyQuick').addEventListener('click', ()=>{
  const val = Number(document.getElementById('quickAdd').value);
  const sel = document.querySelector('.student-row.selected');
  if(!sel) return alert('Select a student row first (click the row).');
  const name = sel.dataset.name;
  const s = findStudentByName(name);
  if(s){ s.points += val; renderAll(); }
});

document.getElementById('studentSort').addEventListener('change', ()=> renderStudents());

const searchInput = document.getElementById('selectSearch');
document.getElementById('searchClear').addEventListener('click', ()=>{ searchInput.value=''; renderStudents(); });
searchInput.addEventListener('input', renderStudents);

/* render students in Students tab (grid aligned) */
function renderStudents(){
  const sortPref = document.getElementById('studentSort').value;
  let arr = [...teacherData.students];
  if(sortPref === 'alpha') arr.sort((a,b)=> a.name.localeCompare(b.name));
  else arr.sort((a,b)=> b.points - a.points || a.name.localeCompare(b.name));

  const q = searchInput.value.trim().toLowerCase();
  if(q) arr = arr.filter(s => s.name.toLowerCase().includes(q));

  const container = document.getElementById('studentList');
  container.innerHTML = '';
  arr.forEach(s => {
    const row = document.createElement('div');
    row.className = 'student-row';
    row.dataset.name = s.name;
    row.innerHTML = `
      <div class="name" title="${s.name}">${s.name}</div>
      <div class="points">${s.points} pts</div>
      <div class="controls">
        <button class="small" data-act="+1">+1</button>
        <button class="small" data-act="-1">‚àí1</button>
        <button class="small" data-act="edit">Edit</button>
        <button class="small danger" data-act="rm">üóëÔ∏è</button>
      </div>
    `;
    // button handlers
    row.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        const act = btn.dataset.act;
        if(act === '+1'){ s.points++; renderAll(); }
        else if(act === '-1'){ s.points--; renderAll(); }
        else if(act === 'rm'){ if(confirm(`Remove ${s.name}?`)){ teacherData.students = teacherData.students.filter(x=> x.name !== s.name); renderAll(); } }
        else if(act === 'edit'){
          const choice = prompt('Type "rename" to rename, "set" to set points, or enter +n / -n to add/subtract:');
          if(!choice) return;
          if(choice.toLowerCase() === 'rename'){
            const newN = normalizeName(prompt('New name:',''));
            if(newN && !teacherData.students.some(x=> x.name.toLowerCase() === newN.toLowerCase())){
              s.name = newN; renderAll();
            } else alert('Invalid or duplicate name');
          } else if(choice.toLowerCase() === 'set'){
            const val = Number(prompt('Set points to:','0'));
            if(!isNaN(val)){ s.points = val; renderAll(); }
          } else {
            const delta = Number(choice);
            if(!isNaN(delta)){ s.points += delta; renderAll(); }
            else alert('Unrecognized command');
          }
        }
      });
    });
    // row click selects
    row.addEventListener('click', (e)=>{
      if(e.target.tagName.toLowerCase() === 'button') return;
      document.querySelectorAll('.student-row').forEach(r=> r.classList.remove('selected'));
      row.classList.add('selected');
    });
    container.appendChild(row);
  });
}

/* LEADERBOARD */
document.getElementById('toggleFullBtn').addEventListener('click', ()=>{
  const full = document.getElementById('fullBoard');
  full.style.display = full.style.display === 'none' || full.style.display === '' ? 'block' : 'none';
  document.getElementById('toggleFullBtn').textContent = full.style.display === 'none' ? 'Show Full Leaderboard ‚Üì' : 'Hide Full Leaderboard ‚Üë';
});

function syncSnapshotSelect(){
  const ss = document.getElementById('snapshotSelect');
  ss.innerHTML = '';
  ss.appendChild(new Option('Current (live)', 'CURRENT'));
  teacherData.history.slice().reverse().forEach(h => ss.appendChild(new Option(formatDate(h.dateISO), h.dateISO)));
}
document.getElementById('refreshSnapshot').addEventListener('click', ()=> renderLeaderboard());

function renderLeaderboard(){
  const sel = document.getElementById('snapshotSelect');
  const chosen = sel ? sel.value : 'CURRENT';
  let list = [];
  if(chosen && chosen !== 'CURRENT'){
    const snap = teacherData.history.find(h=> h.dateISO === chosen);
    list = snap ? sortForLeaderboard(snap.students, teacherData.settings.leaderSort) : [];
  } else {
    list = sortForLeaderboard(teacherData.students, teacherData.settings.leaderSort);
  }

  // podium top 3
  const podiumDiv = document.getElementById('podium');
  podiumDiv.innerHTML = '';
  for(let i=0;i<3;i++){
    const s = list[i];
    const box = document.createElement('div'); box.className = 'box';
    if(i===0) box.classList.add('gold'); else if(i===1) box.classList.add('silver'); else box.classList.add('bronze');
    if(s) box.innerHTML = `${i+1}. ${s.name}<br><span style="font-weight:700">${s.points} pts</span>`;
    else box.innerHTML = `${i+1}. ‚Äî<br><span style="font-weight:700">‚Äî</span>`;
    podiumDiv.appendChild(box);
  }

  // full table
  const tbody = document.getElementById('leaderboardBody');
  tbody.innerHTML = '';
  list.forEach((s, idx)=>{
    const tr = document.createElement('tr');
    if(idx % 2 === 1) tr.classList.add('row-even');
    const cls = s.points > 0 ? 'points-pos' : s.points < 0 ? 'points-neg' : 'points-zero';
    tr.innerHTML = `<td style="width:60px">${idx+1}</td><td>${s.name}</td><td class="${cls}" style="width:120px">${s.points}</td>`;
    tbody.appendChild(tr);
  });
}

/* ADMIN tools wiring */
document.getElementById('importBtn').addEventListener('click', ()=>{
  const raw = document.getElementById('importInput').value;
  if(!raw.trim()) return alert('Paste comma separated names');
  const parts = raw.split(',').map(s=> normalizeName(s)).filter(Boolean);
  let added = 0;
  parts.forEach(name=>{
    if(!teacherData.students.some(s=> s.name.toLowerCase() === name.toLowerCase())){
      teacherData.students.push({ name, points: 0 }); added++;
    }
  });
  document.getElementById('importInput').value = '';
  renderAll();
  alert(`Imported ${added} names`);
});

/* Save data (download JSON) */
document.getElementById('saveDataBtn').addEventListener('click', ()=>{
  const payload = {
    exportedAt: new Date().toISOString(),
    user: currentUser,
    data: teacherData
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `hc_backup_${currentUser}_${new Date().toISOString().slice(0,10)}.json`; a.click();
  URL.revokeObjectURL(url);
});

/* Load data (upload JSON) */
document.getElementById('loadDataBtn').addEventListener('click', ()=> document.getElementById('loadFile').click());
document.getElementById('loadFile').addEventListener('change', (ev)=>{
  const file = ev.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const parsed = JSON.parse(e.target.result);
      if(parsed && parsed.data){
        // if file contains wrapper (export), use parsed.data
        teacherData = parsed.data;
      } else {
        // assume file is raw data
        teacherData = parsed;
      }
      saveTeacherDataAndPersist();
      renderAll();
      alert('Data loaded from file.');
    } catch(err){
      alert('Invalid JSON file.');
    }
  };
  reader.readAsText(file);
});

/* wipe all (for this teacher) */
document.getElementById('wipeAll').addEventListener('click', ()=>{
  if(!confirm('Wipe ALL data for this teacher (keeps account)?')) return;
  teacherData = defaultTeacherData();
  saveTeacherDataAndPersist();
  renderAll();
});

/* Set points for a student */
document.getElementById('applySet').addEventListener('click', ()=>{
  const name = normalizeName(document.getElementById('chooseName').value);
  const val = Number(document.getElementById('setPoints').value);
  if(!name || isNaN(val)) return alert('Provide exact name and numeric value');
  const s = findStudentByName(name);
  if(!s) return alert('Student not found');
  s.points = val; renderAll();
});

/* Rename student */
document.getElementById('renameBtn').addEventListener('click', ()=>{
  const oldN = normalizeName(document.getElementById('renameOld').value);
  const newN = normalizeName(document.getElementById('renameNew').value);
  if(!oldN || !newN) return alert('Enter both names');
  const s = findStudentByName(oldN);
  if(!s) return alert('Old name not found exactly');
  if(teacherData.students.some(x=> x.name.toLowerCase() === newN.toLowerCase())) return alert('New name already exists');
  s.name = newN; renderAll();
});

/* Quick apply */
document.getElementById('quickApply').addEventListener('click', ()=>{
  const amt = Number(document.getElementById('quickAmount').value);
  const target = normalizeName(document.getElementById('quickTarget').value);
  if(!target) return alert('Enter target name');
  const s = findStudentByName(target);
  if(!s) return alert('Student not found');
  s.points += amt; renderAll();
});

/* Weekly reset & history */
document.getElementById('resetWeek').addEventListener('click', ()=>{
  if(!confirm('Archive current scores and reset to zero?')) return;
  teacherData.history.push({ dateISO: new Date().toISOString(), students: cloneStudents(teacherData.students) });
  teacherData.students.forEach(s => s.points = 0);
  renderAll();
  alert('Week archived and points reset.');
});
document.getElementById('clearHistory').addEventListener('click', ()=>{
  if(!confirm('Clear all saved snapshots?')) return;
  teacherData.history = [];
  renderAll();
});

/* Leaderboard sort setting */
document.getElementById('leaderSort').addEventListener('change', (e)=>{
  teacherData.settings.leaderSort = e.target.value; renderAll();
});

/* Graphs snapshot select & draw */
function syncGraphSelect(){
  const sel = document.getElementById('graphSnapshot');
  sel.innerHTML = '';
  sel.appendChild(new Option('Current (live)', 'CURRENT'));
  teacherData.history.slice().reverse().forEach(h => sel.appendChild(new Option(formatDate(h.dateISO), h.dateISO)));
}
document.getElementById('drawGraph').addEventListener('click', ()=> drawChart());

/* Themes */
document.querySelectorAll('[data-theme]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const t = btn.dataset.theme;
    teacherData.settings.theme = t; saveTeacherDataAndPersist(); applyTheme();
  });
});

function applyTheme(){
  document.documentElement.classList.remove('theme-dark','theme-chalk','theme-retro');
  if(teacherData.settings.theme === 'dark') document.documentElement.classList.add('theme-dark');
  if(teacherData.settings.theme === 'chalk') document.documentElement.classList.add('theme-chalk');
  if(teacherData.settings.theme === 'retro') document.documentElement.classList.add('theme-retro');
}

/* ==========================
   Graph drawing with Chart.js
   ========================== */
let chart = null;
function drawChart(){
  const sel = document.getElementById('graphSnapshot').value;
  let arr = [];
  if(sel && sel !== 'CURRENT'){
    const snap = teacherData.history.find(h => h.dateISO === sel);
    arr = snap ? sortForLeaderboard(snap.students, teacherData.settings.leaderSort) : [];
  } else arr = sortForLeaderboard(teacherData.students, teacherData.settings.leaderSort);

  const labels = arr.map(s => s.name);
  const data = arr.map(s => s.points);
  const ctx = document.getElementById('pointsChart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Points',
        data,
        backgroundColor: labels.map((l,i)=> i<3? (i==0?'gold': i==1?'silver':'#cd7f32') : 'rgba(0,123,255,0.6)')
      }]
    },
    options: {
      maintainAspectRatio:false,
      scales: { y: { beginAtZero:false } },
      plugins: { legend: { display:false } }
    }
  });
}

/* Render helpers */
function formatDate(iso){
  const d = new Date(iso);
  return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
}

/* Initial load - show login screen or if only one account and you want auto? We'll show login always */
applyTheme();

/* After login we will call renderAll(); */

/* Helper: after any action persist teacher data to account */
function saveTeacherDataAndPersist(){
  persistTeacherToAccounts();
  saveTeacherDataAndPersist = saveTeacherDataAndPersist; // no-op to avoid lint
}

/* Expose refresh (debug) */
window.renderAll = renderAll;
</script>
</body>
</html>
